<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="proba2.css" />
    <!-- <script src="result13.js"></script> -->
    <!-- <script type="text/javascript" src="result13.js"></script> -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <title>Measurement Application</title>
  </head>
  <body>
    <img src="ftn.jpg" />
    <div id="container" style="height: 400px; min-width: 310px"></div>
    <figure class="highcharts-figure">
      <!-- <div id="container"></div> -->

      <p class="highcharts-description">
        Ovaj grafik predstavlja kolicinu stetnih cestica u vazduhu na podrucju
        Novog Sada. SO2 cestice su jedne od najstetnijih cestica, koje
        "doprinose" zagadjenju vazduha.
      </p>
    </figure>
    <img src="sumpor_dioksid.png" class="right" />
    <script>
      let data;
      const fetchData = async () => {
        try {
          const response = await fetch(
            "https://air-quality.p.rapidapi.com/history/airquality?lon=19.833549&lat=45.267136",
            {
              method: "GET",
              headers: {
                "x-rapidapi-key":
                  "d7ba9255d2msha11a355b8412f5cp1fd28bjsnd404b6bb9b98",
                "x-rapidapi-host": "air-quality.p.rapidapi.com",
              },
            }
          );
          data = await response.json();
          console.log(data);
        } catch (error) {}
      };

      fetchData().then(() => {
        let xData = [];
        let yDataSo2 = [];
        /*let yDataNo2 = [];
        let yDataPM10 = [];
        let yDataCo = [];
        let scrollNum;*/

        for (let i = 0; i < data.data.length; i++) {
          console.log(data.data.length);
          let xNewData = data.data[i].timestamp_local;

          xData.push(xNewData);

          let yNewDataSo2 = data.data[i].so2;
          yDataSo2.push(yNewDataSo2);
        }

        Highcharts.chart("container", {
          chart: {
            type: "spline",
            marginRight: 10,
            events: {
              load: function () {
                // funkcija koja mi update-je podatke svaki sekund i dodaje novi podatak na grafik
                var series = this.series[0];
                let counter = 0;
                setInterval(() => {
                  console.log(counter, xData[counter], yDataSo2[counter]);
                  if (counter < data.data.length) {
                    const x = xData[counter];
                    const y = yDataSo2[counter];
                    series.addPoint([x, y], true, true);
                  }
                  counter++;
                }, 1000);
              },
            },
          },

          time: {
            useUTC: false,
          },

          title: {
            text: "Air Quality Monitoring-Novi Sad",
          },
          //ovo ispod i nije toliko bitno moze se zakomentarisati
          accessibility: {
            announceNewData: {
              enabled: true,
              minAnnounceInterval: 15000,
              announcementFormatter: function (allSeries, newSeries, newPoint) {
                if (newPoint) {
                  return "New point added. Value: " + newPoint.y;
                }
                return false;
              },
            },
          },

          xAxis: {
            type: "datetime",
            tickPixelInterval: 150,
          },

          yAxis: {
            title: {
              text: "Value",
            },
            plotLines: [
              {
                value: 0,
                width: 1,
                color: "#808080",
              },
            ],
          },

          tooltip: {
            headerFormat: "<b>{series.name}</b><br/>",
            pointFormat: "{point.x:%Y-%m-%d %H:%M:%S}<br/>{point.y:.2f}",
          },

          legend: {
            enabled: false,
          },

          exporting: {
            enabled: false,
          },

          series: [
            {
              name: "so2",
              data: (function () {
                // generate an array of random data
                var data = [];
                data.push(xData[0], yDataSo2[0]);
                return data;
              })(),
            },
          ],
        });
      });
    </script>
  </body>
</html>
