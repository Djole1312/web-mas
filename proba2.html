<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="proba2.css" />
    <!-- <script src="result13.js"></script> -->
    <!-- <script type="text/javascript" src="result13.js"></script> -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <title>Measurement Application</title>
  </head>
  <body>
    <img src="ftn.jpg" />
    <div>
      <div
        id="container"
        style="height: 400px; min-width: 310px; position: relative; left: auto"
      ></div>
      <div style="height: 50px; width: 10px"></div>
      <div
        id="container1"
        style="height: 400px; min-width: 310px; position: relative; right: auto"
      ></div>
    </div>
    <figure class="highcharts-figure">
      <!-- <div id="container"></div> -->

      <p class="highcharts-description">
        <i>
          Ovaj grafik predstavlja kolicinu stetnih cestica u vazduhu na podrucju
          Novog Sada. SO2 cestice su jedne od najstetnijih cestica, koje
          "doprinose" zagadjenju vazduha.</i
        >
      </p>
    </figure>
    <img src="sumpor_dioksid.png" class="right" />
    <script>
      let data;
      const fetchData = async () => {
        try {
          const response = await fetch(
            "https://air-quality.p.rapidapi.com/history/airquality?lon=19.833549&lat=45.267136",
            {
              method: "GET",
              headers: {
                "x-rapidapi-key":
                  "d7ba9255d2msha11a355b8412f5cp1fd28bjsnd404b6bb9b98",
                "x-rapidapi-host": "air-quality.p.rapidapi.com",
              },
            }
          );
          data = await response.json();
          console.log(data);
        } catch (error) {}
      };

      fetchData().then(() => {
        let xData = [];
        let yDataSo2 = [];
        let yDataPM25 = [];
        let yDataAQI = [];
        /*let yDataNo2 = [];
          let yDataPM10 = [];
          let yDataCo = [];*/

        for (let i = 0; i < data.data.length; i++) {
          console.log(data.data.length);

          let xNewData = data.data[i].timestamp_local;
          xData.push(xNewData);

          let yNewDataSo2 = data.data[i].so2;
          yDataSo2.push(yNewDataSo2);

          let yNewDataPM25 = data.data[i].pm25;
          yDataPM25.push(yNewDataPM25);

          let yNewDataAQI = data.data[i].aqi;
          yDataAQI.push(yNewDataAQI);
        }

        // prvi grafik
        Highcharts.chart("container", {
          chart: {
            type: "column",
            marginRight: 10,
            events: {
              load: function () {
                // funkcija koja mi update-je podatke svaki sekund i dodaje novi podatak na grafik
                var seriesSO2 = this.series[0];
                var seriesPM25 = this.series[1];
                let counter = 0;
                setInterval(() => {
                  console.log(
                    counter,
                    xData[counter],
                    yDataSo2[counter],
                    "SO2",
                    yDataPM25[counter],
                    "PM25"
                  );
                  if (counter < data.data.length) {
                    let x = xData[counter];
                    let y = yDataSo2[counter];
                    let y1 = yDataPM25[counter];

                    seriesSO2.addPoint([x, y], true, true);
                    seriesPM25.addPoint([x, y1], true, true);
                  }
                  /*if (counter == data.data.length - 1) {
                      counter = 0;
                    }*/
                  counter++;
                }, 1000);
              },
            },
          },

          time: {
            useUTC: false,
          },

          title: {
            text: "Air Quality Monitoring-Novi Sad",
          },

          xAxis: {
            title: {
              text: "Time",
            },
            categories: xData,
            type: "datetime",
          },

          yAxis: {
            title: {
              text: "Value",
            },
            plotLines: [
              {
                value: 0,
                width: 1,
                color: "#808080",
              },
            ],
          },

          legend: {
            enabled: false,
            layout: "vertical",
            align: "left",
            x: 80,
            verticalAlign: "top",
            y: 55,
            floating: true,
            backgroundColor:
              (Highcharts.theme && Highcharts.theme.legendBackgroundColor) ||
              "#FFFFFF",
          },

          exporting: {
            enabled: false,
          },

          series: [
            {
              name: "so2",
              data: (function () {
                let dataSO2 = [];
                for (let i = 0; i < 8; i++) {
                  dataSO2.push({ x: xData[i], y: yDataSo2[i] });
                }
                return dataSO2;
              })(),
            },
            {
              name: "pm25",
              data: (function () {
                let dataPM25 = [];
                for (let j = 0; j < 8; j++) {
                  dataPM25.push({ x: xData[j], y: yDataPM25[j] });
                }
                return dataPM25;
              })(),
            },
          ],
        });

        // drugi grafik
        Highcharts.chart("container1", {
          chart: {
            type: "line",
            marginRight: 8,
            events: {
              load: function () {
                // funkcija koja mi update-je podatke svaki sekund i dodaje novi podatak na grafik
                var series = this.series[0];
                let counter = 0;
                setInterval(() => {
                  console.log(
                    counter,
                    xData[counter],
                    yDataAQI[counter],
                    "AQI"
                  );
                  if (counter < data.data.length) {
                    let x = xData[counter];
                    let y = yDataAQI[counter];

                    series.addPoint([x, y], true, true);
                  }
                  if (counter == data.data.length - 1) {
                    counter = 0;
                  }
                  counter++;
                }, 1000);
              },
            },
          },

          plotOptions: {
            line: {
              dataLabels: {
                enabled: true,
              },
              enableMouseTracking: false,
            },
          },

          time: {
            useUTC: false,
          },

          title: {
            text: "AQI Monitoring-Novi Sad",
          },

          xAxis: {
            type: "datetime",
            categories: xData,
          },

          yAxis: {
            plotLines: [
              {
                value: 0,
                width: 1,
                color: "#808080",
              },
            ],
            className: "highcharts-color-0",
            title: {
              text: "AQI",
            },
          },

          className: "highcharts-color-1",
          opposite: true,
          title: {
            text: "AQI Monitoring-Novi Sad",
          },

          legend: {
            enabled: false,
            layout: "vertical",
            align: "left",
            x: 80,
            verticalAlign: "top",
            y: 55,
            floating: true,
            backgroundColor:
              (Highcharts.theme && Highcharts.theme.legendBackgroundColor) ||
              "#FFFFFF",
          },

          exporting: {
            enabled: false,
          },

          series: [
            {
              name: "aqi",
              data: (function () {
                // generate an array of random data
                var dataAQI = [];

                for (let i = 0; i < 8; i++) {
                  dataAQI.push({ x: xData[i], y: yDataAQI[i] });
                }
                return dataAQI;
              })(),
            },
          ],
        });
      });
    </script>
  </body>
</html>
